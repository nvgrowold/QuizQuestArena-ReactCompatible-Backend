<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <title>Manage Quizzes</title>
    <link rel="stylesheet" href="/css/viewQuizzes.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<h1>Manage Quiz Tournaments</h1>
<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Category</th>
        <th>Difficulty</th>
        <th>Start Date</th>
        <th>End Date</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="quiz : ${quizzes}">
        <td th:text="${quiz.id}"></td>
        <td th:text="${quiz.name}"></td> <!-- Null-safe handling -->
        <td th:text="${quiz.category}"></td> <!-- Null-safe handling -->
        <td th:text="${quiz.difficulty}"></td> <!-- Null-safe handling -->
        <td th:text="${quiz.startDate}"></td> <!-- Null-safe -->
        <td th:text="${quiz.endDate}"></td> <!-- Null-safe -->
        <td>
            <button class="edit-button"
                    th:data-id="${quiz.id}"
                    th:data-name="${quiz.name}"
                    th:data-category="${quiz.category}"
                    th:data-difficulty="${quiz.difficulty}"
                    th:data-start-date="${quiz.startDate}"
                    th:data-end-date="${quiz.endDate}">
                Edit
            </button>
            <button class="delete-button" th:data-id="${quiz.id}" th:data-name="${quiz.name}">Delete</button>
        </td>
    </tr>
    </tbody>
</table>

<!-- Edit Quiz Modal -->
<div id="editModal" style="display:none;">
    <h3>Edit Quiz</h3>
    <form id="editForm">
        <input type="hidden" id="quizId" />
        <label for="quizName">Name:</label>
        <input type="text" id="quizName" required /><br />
        <label for="quizCategory">Category:</label>
        <input type="text" id="quizCategory" readonly /><br />
        <label for="quizDifficulty">Difficulty:</label>
        <input type="text" id="quizDifficulty" readonly /><br />
        <label for="startDate">Start Date:</label>
        <input type="datetime-local" id="startDate" required /><br />
        <label for="endDate">End Date:</label>
        <input type="datetime-local" id="endDate" required /><br />
        <button type="button" id="saveChanges">Save Changes</button>
        <button type="button" id="cancelEdit">Cancel</button>
    </form>
</div>

<!-- Delete Confirmation -->
<div id="deleteModal" style="display:none; background: #eee; padding: 20px; border: 1px solid black;">
    <h3>Delete Confirmation</h3>
    <p id="deleteMessage"></p>
    <button id="confirmDelete">Yes</button>
    <button id="cancelDelete">No</button>
</div>
<script>
    $(document).ready(function () {
        let selectedQuizId;

        // Open Edit Modal
        $(document).on('click', '.edit-button', function () {
            const quizId = $(this).data('id');
            const quizName = $(this).data('name');
            const quizCategory = $(this).data('category');
            const quizDifficulty = $(this).data('difficulty');
            const startDate = $(this).data('start-date');
            const endDate = $(this).data('end-date');

            $('#quizId').val(quizId);
            $('#quizName').val(quizName);
            $('#quizCategory').val(quizCategory);
            $('#quizDifficulty').val(quizDifficulty);
            $('#startDate').val(startDate);
            $('#endDate').val(endDate);

            $('#editModal').show();
        });

        // Save Changes
        $('#saveChanges').on('click', function () {
            const quizData = {
                id: $('#quizId').val(),
                name: $('#quizName').val(),
                category: $('#quizCategory').val(),
                difficulty: $('#quizDifficulty').val(),
                startDate: $('#startDate').val(),
                endDate: $('#endDate').val(),
            };

            $.ajax({
                type: 'POST',
                url: '/update-quiz',
                contentType: 'application/json',
                data: JSON.stringify(quizData),
                success: function (response) {
                    $('#message').text('Quiz updated successfully!').show();
                    location.reload();
                },
                error: function () {
                    alert('Failed to update quiz.');
                }
            });
        });

        // Open Delete Modal
        $(document).on('click', '.delete-button', function () {
            selectedQuizId = $(this).data('id');
            const quizName = $(this).data('name');
            $('#deleteMessage').text(`Are you sure you want to delete the quiz "${quizName}"?`);
            $('#deleteModal').show();
        });

        // Confirm Delete
        $('#confirmDelete').on('click', function () {
            $.ajax({
                type: 'POST',
                url: `/delete-quiz/${selectedQuizId}`, // Use the correct variable
                success: function (response) {
                    if (response === 'success') {
                        alert('Quiz deleted successfully!');
                        location.reload();
                    } else {
                        alert('Failed to delete quiz: ' + response);
                    }
                },
                error: function () {
                    alert('Error while deleting the quiz.');
                }
            });
        });

        // Cancel Actions
        $('#cancelEdit').on('click', function () {
            $('#editModal').hide();
        });

        $('#cancelDelete').on('click', function () {
            $('#deleteModal').hide();
        });
    });
</script>
</body>
</html>
